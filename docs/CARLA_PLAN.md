# Carla Integration Plan

## Overview
MUSaiC will use [Carla](https://kx.studio/Applications:Carla) as its backend for offline plugin hosting and rendering. Carla provides a headless mode and supports VST2, VST3, AU, LV2, and LADSPA formats.

## Invocation Strategy
We will wrap the Carla CLI binary.
- **Command**: `carla-single` (or `carla-rack` in headless mode).
- **Input**: A `.carla` project file generated by MUSaiC, OR dynamic loading via CLI arguments.
- **Rendering**: Carla can render to audio files in non-realtime (offline) mode. Use `--export-to-audio-file` or `--render` depending on version.
- **Prototype**: `musaic-carla.ps1` is a prototype and exits non-zero if headless render flags are unavailable.
- **Minimal Patch**: If `-ProjectPath` is missing, `musaic-carla.ps1` generates a minimal `.carla` XML in `./output` containing a single VST3 rack.

## Track Mapping
- **1 MUSaiC Track** -> **1 Carla Rack** (conceptually).
- We will generate a `.carla` patch file for each track that requires plugin processing.
- The render engine will trigger Carla to process the audio clips defined in the track.

## Automation
- **Strategy**: Map MUSaiC automation curves to MIDI CC messages.
- **Routing**: Send MIDI events to the Carla instance's control port.
- **Alternative**: Generate an automation file that Carla can ingest (OSC).

## Known Limitations
- **VST3**: Support is generally good but requires recent Carla versions.
- **Bridging**: 32-bit/64-bit bridging is handled by Carla.
- **Shell Plugins**: Waves/Kontakt style shells might need specific handling.
- **Headless**: Not all Carla builds support full headless render; validation will check for `--render` or `--export-to-audio-file`.

## OS Notes
- **Windows**: Set `carlaPath` in `musaic.config.json` or ensure `carla-single`/`Carla.exe` is in PATH.
- **Linux/Mac**: Standard paths.
